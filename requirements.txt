import asyncio
import logging
from os import getenv

from engine.core import Engine
from engine.desc import Ref
from engine.fb.events.E_RESTART import E_RESTART
from engine.fb.utils.OUT_ANY_CONSOLE import OUT_ANY_CONSOLE
from server import Listener

event_loop = asyncio.new_event_loop()
asyncio.set_event_loop(event_loop)

async def main():
    logging.basicConfig(level=logging.DEBUG, format='%(asctime)s [%(levelname)s] %(message)s')

    e = Engine(event_loop)

    # e.add_fb('1', E_RESTART())
    # e.add_fb('2', OUT_ANY_CONSOLE())
    # e.add_connection('3', Ref('1', 'COLD'), Ref('2', 'REQ'))
    # e.add_input('4', Ref('2', 'IN'), 'Hello, world!')

    # await e.run()

    Listener(
        getenv('BIND_ADDR'),
        int(getenv('BIND_PORT')),
        int(getenv('MAX_CONNS')),
        e
    ).listen()

if __name__ == '__main__':
    asyncio.run(main())
